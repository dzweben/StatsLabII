---
title: "Lab 9"
author: "Joshua Klugman"
output:
  word_document:
    reference_docx: "../lab_09.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
input_dir <- tryCatch(dirname(knitr::current_input()), error = function(e) NA)
root_dir <- if (is.na(input_dir) || input_dir == ".") getwd() else normalizePath(file.path(input_dir, ".."))

find_file_up <- function(fname, start = root_dir) {
  candidates <- c(start, dirname(start), file.path(start, "lab09"), file.path(start, "StatsII-Labs", "lab09"))
  for (p in candidates) {
    fp <- file.path(p, fname)
    if (file.exists(fp)) return(fp)
  }
  return(fname)
}

.libPaths(c(file.path(root_dir, "rlib"), .libPaths()))

library(tidyverse)
library(haven)
library(emmeans)
library(afex)
library(pastecs)
library(car)
source(find_file_up("Rallfun-v45.txt"))
```

# Lab 9

## Problem 1 (0 pts)

Load these packages: `afex`, `car`, `emmeans`, `haven`. If they have not been installed, you will need to install them.

Also load Rand Wilcox’s `Rallfun-v45.txt` page of functions, with `source("https://osf.io/download/98b7r/")`.

Syntax:

```{r p1_syntax, eval=FALSE}
library(afex)
library(car)
library(emmeans)
library(haven)
source(find_file_up("Rallfun-v45.txt"))
```

Output:

```{r p1_output, echo=FALSE}
library(afex)
library(car)
library(emmeans)
library(haven)
source(find_file_up("Rallfun-v45.txt"))
```

## Problem 2 (0 pts)

Read in the `wordsum v2.sav` datafile into the R environment.

Syntax:

```{r p2_syntax, eval=FALSE}
ws <- read_sav(find_file_up("wordsum v2.sav"))
head(ws)
```

Output:

```{r p2_output, echo=FALSE}
ws <- read_sav(find_file_up("wordsum v2.sav"))
head(ws)
```

## Problem 3 (1 pt)

Copy and paste your Excel table of marginal and cell means from the prior lab. If you made mistakes in that lab assignment, correct the table and paste it.

Syntax:

```text
Excel table pasted below.
```

Output:

```{r p3_table, echo=FALSE, fig.cap="Cell and marginal means"}
knitr::include_graphics(find_file_up("q3_cell_marginal.png"))
```

## Problem 4 (3 pts)

Create the factor versions of the `sized` and `regions` variable, and an ID variable. Produce two-way tables confirming the factor variables were generated correctly.

Syntax:

```{r p4_syntax, eval=FALSE}
ws$sized_f <- factor(ws$sized, levels = c(0, 1), labels = c("Non-City", "City"))
ws$regions_f <- factor(ws$regions, levels = c(1, 2, 3, 4), labels = c("Midwest", "Northeast", "South", "West"))
ws$id <- rownames(ws)

table(ws$sized, ws$sized_f, exclude = NULL)

table(ws$regions, ws$regions_f, exclude = NULL)
```

Output:

```{r p4_output, echo=FALSE}
ws$sized_f <- factor(ws$sized, levels = c(0, 1), labels = c("Non-City", "City"))
ws$regions_f <- factor(ws$regions, levels = c(1, 2, 3, 4), labels = c("Midwest", "Northeast", "South", "West"))
ws$id <- rownames(ws)

table(ws$sized, ws$sized_f, exclude = NULL)

table(ws$regions, ws$regions_f, exclude = NULL)
```

## Problem 5 (5 pts)

Run the two-way ANOVA, store and print the `emmGrid` objects, and print the output of the two way ANOVA.

Syntax:

```{r p5_syntax, eval=FALSE}
ws_anova <- aov_car(ws ~ sized_f * regions_f + Error(id), data = ws)

em_cell <- emmeans(ws_anova, ~ sized_f * regions_f)
em_sized <- emmeans(ws_anova, ~ sized_f)
em_regions <- emmeans(ws_anova, ~ regions_f)

em_cell
em_sized
em_regions

summary(ws_anova)
ws_anova$Anova
```

Output:

```{r p5_output, echo=FALSE}
ws_anova <- aov_car(ws ~ sized_f * regions_f + Error(id), data = ws)

em_cell <- emmeans(ws_anova, ~ sized_f * regions_f)
em_sized <- emmeans(ws_anova, ~ sized_f)
em_regions <- emmeans(ws_anova, ~ regions_f)

em_cell
em_sized
em_regions

summary(ws_anova)
ws_anova$Anova
```

## Problem 6 (1 pt)

Write a null hypothesis testing the main effect of the South-West difference.

Syntax:

```text
Null: there is no difference between the South and West marginal means.
Formula: H0: (-1)*μ_S + (1)*μ_W = 0.
```

Output:

```text
Null: there is no difference between the South and West marginal means.
Formula: H0: (-1)*μ_S + (1)*μ_W = 0.
```

## Problem 7 (1 pt)

Produce pair-wise contrasts for the main effects of region, using a Tukey-HSD adjustment.

Syntax:

```{r p7_syntax, eval=FALSE}
pairs(em_regions, adjust = "tukey")
```

Output:

```{r p7_output, echo=FALSE}
pairs(em_regions, adjust = "tukey")
```

## Problem 8 (2 pt)

Use R to calculate the Scheffe-adjusted critical value for the **main effects of region**, keeping the *familywise* error rate at 0.05. Take the square root of the critical value so it could be used to assess a *t* test statistic.

Syntax:

```{r p8_syntax, eval=FALSE}
alpha <- 0.05
A <- 4
an <- as.data.frame(ws_anova$Anova)
df_error <- an$Df[5]

scheffe_main_region_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
scheffe_main_region_t
```

Output:

```{r p8_output, echo=FALSE}
alpha <- 0.05
A <- 4
an <- as.data.frame(ws_anova$Anova)
df_error <- an$Df[5]

scheffe_main_region_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
scheffe_main_region_t
```

## Problem 9 (1 pt)

Write the null hypothesis for the simple effect of city status for people living in the Northeast.

Syntax:

```text
Null: within the Northeast, city and non‑city population means are equal.
Formula: H0: (-1)*μ_C,NE + (1)*μ_NC,NE = 0.
```

Output:

```text
Null: within the Northeast, city and non‑city population means are equal.
Formula: H0: (-1)*μ_C,NE + (1)*μ_NC,NE = 0.
```

## Problem 10 (1 pt)

Have R produce contrasts for the effect of city resident status for each region. It does not matter if you specify "none" or "tukey" for `adjust`--with two levels in the focal predictor the Tukey adjustment is equivalent to no adjustment.

Syntax:

```{r p10_syntax, eval=FALSE}
pairs(em_cell, simple = "sized_f", adjust = "none")
```

Output:

```{r p10_output, echo=FALSE}
pairs(em_cell, simple = "sized_f", adjust = "none")
```

## Problem 11 (2 pts)

We need to account for the fact that we can do the city vs non-city contrast for four regions. Use R to calculate the post-hoc adjusted critical value for the simple main effects of city resident status, keeping the familywise error rate at .05.

Syntax:

```{r p11_syntax, eval=FALSE}
crit_t_city_simple <- qtukey(1 - alpha/4, 2, df_error) / sqrt(2)
crit_t_city_simple
```

Output:

```{r p11_output, echo=FALSE}
crit_t_city_simple <- qtukey(1 - alpha/4, 2, df_error) / sqrt(2)
crit_t_city_simple
```

## Problem 12 (4 pts)

For each contrast (the city-noncity comparison within each region) calculate Cohen’s *d*.

Syntax:

```{r p12_syntax, eval=FALSE}
sc_city <- as.data.frame(pairs(em_cell, simple = "sized_f", adjust = "none"))
ss <- an$`Sum Sq`
names(ss) <- row.names(an)
ss_error <- ss["Residuals"]
MSE <- ss_error / df_error
sd_pooled <- sqrt(MSE)
sc_city$d <- sc_city$estimate / sd_pooled
sc_city
```

Output:

```{r p12_output, echo=FALSE}
sc_city <- as.data.frame(pairs(em_cell, simple = "sized_f", adjust = "none"))
ss <- an$`Sum Sq`
names(ss) <- row.names(an)
ss_error <- ss["Residuals"]
MSE <- ss_error / df_error
sd_pooled <- sqrt(MSE)
sc_city$d <- sc_city$estimate / sd_pooled
sc_city
```

## Problem 13 (5 pts)

Write Up the results of the pairwise contrasts of city resident status, using the Bonferroni-adjusted threshold for significance (that is, accounting for the fact you did four comparisons–city vs. non-city in four regions). Your interpretation should report direction of the associations (that is which group has higher vocabulary scores), the effect size, and the p value (make clear if you are using the Bonferroni-adjusted p value or the unadjusted p value).

Syntax:

```{r p13_syntax, eval=FALSE}
sc_city$bonf_p <- p.adjust(sc_city$p.value, method = "bonferroni")
sc_city
```

Output:

```{r p13_output, echo=FALSE}
sc_city$bonf_p <- p.adjust(sc_city$p.value, method = "bonferroni")
sc_city
```

APA-style write-up (Bonferroni-adjusted): In the Midwest, city dwellers scored higher than non-city dwellers, t(312) = 2.96, p_bonf = .013, d = 0.66. In the Northeast, non-city dwellers scored higher than city dwellers, t(312) = 7.23, p_bonf < .001, d = 1.62. In the South, the city vs non-city difference was not significant, t(312) = 0.36, p_bonf = 1.00, d = 0.08 (city slightly higher). In the West, the city vs non-city difference was not significant, t(312) = 1.07, p_bonf = 1.00, d = 0.24 (non-city slightly higher).

## Problem 14 (1 pt)

Write a null hypothesis for the simple effect of Midwest versus Northeast, among city dwellers.

Syntax:

```text
Null: among city dwellers, the Midwest and Northeast population means are equal.
Formula: H0: (-1)*μ_C,MW + (1)*μ_C,NE = 0.
```

Output:

```text
Null: among city dwellers, the Midwest and Northeast population means are equal.
Formula: H0: (-1)*μ_C,MW + (1)*μ_C,NE = 0.
```

## Problem 15 (1 pt)

Have R produce pairwise contrasts for region among city-dwellers and among non-city dwellers (that is, the simple effects of region by city status). Again, specify "none" for `adjust`.

Syntax:

```{r p15_syntax, eval=FALSE}
pairs(em_cell, simple = "regions_f", adjust = "none")
```

Output:

```{r p15_output, echo=FALSE}
pairs(em_cell, simple = "regions_f", adjust = "none")
```

## Problem 16 (2 pts)

We need to account for the fact that we can do the region comparisons for two urbanicity statuses. Use R to calculate the Tukey HSD adjusted critical value for the simple main effects of region by city status, keeping the familywise error rate at 0.05 (a "Tukey HSD + Bonferroni" adjustment).

Syntax:

```{r p16_syntax, eval=FALSE}
crit_t_region_simple <- qtukey(1 - alpha/2, A, df_error) / sqrt(2)
crit_t_region_simple
```

Output:

```{r p16_output, echo=FALSE}
crit_t_region_simple <- qtukey(1 - alpha/2, A, df_error) / sqrt(2)
crit_t_region_simple
```

## Problem 17 (12 pts)

Identify the contrasts that survive the Tukey HSD+Bonferroni adjustment.

Syntax:

```{r p17_syntax, eval=FALSE}
sc_region <- as.data.frame(pairs(em_cell, simple = "regions_f", adjust = "none"))
sc_region$survive <- abs(sc_region$t.ratio) >= crit_t_region_simple
sc_region[sc_region$survive == TRUE, c("contrast", "sized_f", "t.ratio", "p.value")]
```

Output:

```{r p17_output, echo=FALSE}
sc_region <- as.data.frame(pairs(em_cell, simple = "regions_f", adjust = "none"))
sc_region$survive <- abs(sc_region$t.ratio) >= crit_t_region_simple
sc_region[sc_region$survive == TRUE, c("contrast", "sized_f", "t.ratio", "p.value")]
```

## Problem 18 (3 pt)

Write three null hypotheses:

* the simple effect of Northeast vs Midwest and West, among city-dwellers
* the simple effect of Northeast vs Midwest and West, among non-city dwellers.
* the interaction contrast comparing the above two simple effects

Syntax:

```text
City dwellers, NE vs MW & W:
Null: among city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
Formula: H0: (-0.5)*μ_C,MW + (1)*μ_C,NE + (-0.5)*μ_C,W = 0.

Non-city dwellers, NE vs MW & W:
Null: among non‑city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
Formula: H0: (-0.5)*μ_NC,MW + (1)*μ_NC,NE + (-0.5)*μ_NC,W = 0.

Interaction contrast:
Null: the Northeast vs (Midwest & West) contrast is the same for city and non‑city dwellers (no interaction contrast).
Formula: H0: (0.5)*μ_NC,MW + (-0.5)*μ_C,MW + (-1)*μ_NC,NE + (1)*μ_C,NE + (0.5)*μ_NC,W + (-0.5)*μ_C,W = 0.
```

Output:

```text
City dwellers, NE vs MW & W:
Null: among city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
Formula: H0: (-0.5)*μ_C,MW + (1)*μ_C,NE + (-0.5)*μ_C,W = 0.

Non-city dwellers, NE vs MW & W:
Null: among non‑city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
Formula: H0: (-0.5)*μ_NC,MW + (1)*μ_NC,NE + (-0.5)*μ_NC,W = 0.

Interaction contrast:
Null: the Northeast vs (Midwest & West) contrast is the same for city and non‑city dwellers (no interaction contrast).
Formula: H0: (0.5)*μ_NC,MW + (-0.5)*μ_C,MW + (-1)*μ_NC,NE + (1)*μ_C,NE + (0.5)*μ_NC,W + (-0.5)*μ_C,W = 0.
```

## Problem 19 (3 pt)

Create contrast vectors for a complex contrast of Northeast vs Midwest and West among city dwellers and non-city dwellers. Your vectors should have eight values in them, listing the contrast coefficients for the cells, in the order they are listed in the cell `emmGrid` object.

Syntax:

```{r p19_syntax, eval=FALSE}
contrast_city <- c(0, -0.5, 0, 1, 0, 0, 0, -0.5)
contrast_noncity <- c(-0.5, 0, 1, 0, 0, 0, -0.5, 0)
contrast_interaction <- contrast_city - contrast_noncity

contrast_city
contrast_noncity
contrast_interaction
```

Output:

```{r p19_output, echo=FALSE}
contrast_city <- c(0, -0.5, 0, 1, 0, 0, 0, -0.5)
contrast_noncity <- c(-0.5, 0, 1, 0, 0, 0, -0.5, 0)
contrast_interaction <- contrast_city - contrast_noncity

contrast_city
contrast_noncity
contrast_interaction
```

## Problem 20 (1 pt)

Assemble the contrast vectors in a list.

Syntax:

```{r p20_syntax, eval=FALSE}
contrast_list <- list(
  city_NE_vs_MW_W = contrast_city,
  noncity_NE_vs_MW_W = contrast_noncity,
  interaction_NE_vs_MW_W = contrast_interaction
)
contrast_list
```

Output:

```{r p20_output, echo=FALSE}
contrast_list <- list(
  city_NE_vs_MW_W = contrast_city,
  noncity_NE_vs_MW_W = contrast_noncity,
  interaction_NE_vs_MW_W = contrast_interaction
)
contrast_list
```

## Problem 21 (1 pt)

Have R calculate these contrasts using the cell `emmGRID` object. Do not apply any adjustments--yet.

Syntax:

```{r p21_syntax, eval=FALSE}
complex_contrasts <- contrast(em_cell, contrast_list, adjust = "none")
complex_contrasts
```

Output:

```{r p21_output, echo=FALSE}
complex_contrasts <- contrast(em_cell, contrast_list, adjust = "none")
complex_contrasts
```

## Problem 22 (2 pts)

Calculate the Scheffe- and Bonferroni-adjusted critical value for a a complex simple contrast of region by city status. Take the square root to get a critical value comparable to a t-statistic.

Syntax:

```{r p22_syntax, eval=FALSE}
scheffe_simple_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
bonf_simple_t <- qtukey(1 - alpha/2, 2, df_error) / sqrt(2)

scheffe_simple_t
bonf_simple_t
```

Output:

```{r p22_output, echo=FALSE}
scheffe_simple_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
bonf_simple_t <- qtukey(1 - alpha/2, 2, df_error) / sqrt(2)

scheffe_simple_t
bonf_simple_t
```

## Problem 23 (2 pt)

Calculate the Scheffe-adjusted critical value for an interaction contrast. Take the square root to get a critical value comparable to a t-statistic.

Syntax:

```{r p23_syntax, eval=FALSE}
scheffe_interaction_t <- sqrt((A - 1) * (2 - 1) * qf(1 - alpha, (A - 1) * (2 - 1), df_error))
scheffe_interaction_t
```

Output:

```{r p23_output, echo=FALSE}
scheffe_interaction_t <- sqrt((A - 1) * (2 - 1) * qf(1 - alpha, (A - 1) * (2 - 1), df_error))
scheffe_interaction_t
```

## Problem 24 (3 pt)

Calculate Cohen's *d* for the three contrasts.

Syntax:

```{r p24_syntax, eval=FALSE}
cc <- as.data.frame(complex_contrasts)
cc$d <- cc$estimate / sd_pooled
cc
```

Output:

```{r p24_output, echo=FALSE}
cc <- as.data.frame(complex_contrasts)
cc$d <- cc$estimate / sd_pooled
cc
```

## Problem 25 (5 pts)

Write-up the Northeast vs Midwest & West contrasts (and interaction contrast) as you would for a publication.

APA-style write-up: For city dwellers, the Northeast vs (Midwest & West) contrast was significant, t(312) = 5.61, p < .001, d = 1.09, indicating lower Northeast scores than the average of Midwest and West for city residents (contrast estimate = -1.03). For non-city dwellers, the same contrast was significant, t(312) = 3.83, p = .0002, d = 0.74, indicating higher Northeast scores than the average of Midwest and West (estimate = 0.70). The interaction contrast was significant, t(312) = 6.67, p < .001, d = 1.83, showing that the Northeast advantage differs sharply by city status.

## Problem 26 (0 pts)

Upload to Canvas and verify submission.
