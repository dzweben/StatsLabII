---
title: "Lab 9"
author: "Danny Zweben"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

setwd("/Users/dannyzweben/Desktop/GradClass/Y1/S2/StatsII/StatsII-Labs/lab09")

library(tidyverse)
library(haven)
library(emmeans)
library(afex)
library(pastecs)
library(car)
source("https://osf.io/download/98b7r/")
```

# Lab 9 overview

You are continuing to use the SPSS datafile `wordsum v2.sav` that you used for Lab 8. This is a vocabulary test administered to people from different regions of the United States, with scores ranging from 0 to 10. We have a 2×4 design, with our two factors being a city resident (versus not being a city resident; this is variable `sized`) and region (Midwest, Northeast, South, and West; this is variable `regions`). The outcome is the vocabulary score (variable `ws` which is a count variable ranging from 0 correct words to 10 correct words).

# Problem 1 (0 pts)

Load these packages: `afex`, `car`, `emmeans`, `haven`. If they have not been installed, you will need to install them.

Also load Rand Wilcox’s `Rallfun-v45.txt` page of functions, with `source("https://osf.io/download/98b7r/")`.

```{r}
library(afex)
library(car)
library(emmeans)
library(haven)
source("https://osf.io/download/98b7r/")
```

# Problem 2 (0 pts)

Read in the `wordsum v2.sav` datafile into the R environment.

```{r}
ws <- read_sav("wordsum v2.sav")
head(ws)
```

# Problem 3 (1 pt)

Copy and paste your Excel table of marginal and cell means from the prior lab. If you made mistakes in that lab assignment, correct the table and paste it.

# Problem 4 (3 pts)

Create the factor versions of the `sized` and `regions` variable, and an ID variable. Produce two-way tables confirming the factor variables were generated correctly.

```{r}
ws$sized_f <- factor(ws$sized, levels = c(0, 1), labels = c("Non-City", "City"))
ws$regions_f <- factor(ws$regions, levels = c(1, 2, 3, 4), labels = c("Midwest", "Northeast", "South", "West"))
ws$id <- rownames(ws)

table(ws$sized, ws$sized_f, exclude = NULL)

table(ws$regions, ws$regions_f, exclude = NULL)
```

# Problem 5 (5 pts)

Run the two-way ANOVA, store and print the `emmGrid` objects, and print the output of the two way ANOVA.

```{r}
ws_anova <- aov_car(ws ~ sized_f * regions_f + Error(id), data = ws)

em_cell <- emmeans(ws_anova, ~ sized_f * regions_f)
em_sized <- emmeans(ws_anova, ~ sized_f)
em_regions <- emmeans(ws_anova, ~ regions_f)

em_cell
em_sized
em_regions

summary(ws_anova)
ws_anova$Anova
```

# Problem 6 (1 pt)

Write a null hypothesis testing the main effect of the South-West difference.

Null: there is no difference between the South and West marginal means.

# Problem 7 (1 pt)

Produce pair-wise contrasts for the main effects of region, using a Tukey-HSD adjustment.

```{r}
pairs(em_regions, adjust = "tukey")
```

# Problem 8 (2 pt)

Use R to calculate the Scheffe-adjusted critical value for the **main effects of region**, keeping the *familywise* error rate at 0.05. Take the square root of the critical value so it could be used to assess a *t* test statistic.

```{r}
alpha <- 0.05
A <- 4
an <- as.data.frame(ws_anova$Anova)
df_error <- an$Df[5]

scheffe_main_region_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
scheffe_main_region_t
```

# Problem 9 (1 pt)

Write the null hypothesis for the simple effect of city status for people living in the Northeast.

Null: within the Northeast, city and non‑city population means are equal.

# Problem 10 (1 pts)

Have R produce contrasts for the effect of city resident status for each region. It does not matter if you specify `"none"` or `"tukey"` for `adjust`--with two levels in the focal predictor the Tukey adjustment is equivalent to no adjustment.

```{r}
pairs(em_cell, simple = "sized_f", adjust = "none")
```

# Problem 11 (2 pts)

We need to account for the fact that we can do the city vs non-city contrast for four regions. Use R to calculate the post-hoc adjusted critical value for the simple main effects of city resident status, keeping the familywise error rate at .05.

```{r}
crit_t_city_simple <- qtukey(1 - alpha/4, 2, df_error) / sqrt(2)
crit_t_city_simple
```

# Problem 12 (4 pts)

For each contrast (the city-noncity comparison within each region) calculate Cohen’s *d*.

```{r}
sc_city <- as.data.frame(pairs(em_cell, simple = "sized_f", adjust = "none"))
ss <- an$`Sum Sq`
names(ss) <- row.names(an)
ss_error <- ss["Residuals"]
MSE <- ss_error / df_error
sd_pooled <- sqrt(MSE)
sc_city$d <- sc_city$estimate / sd_pooled
sc_city
```

# Problem 13 (5 pts)

Write Up the results of the pairwise contrasts of city resident status, using the Bonferroni-adjusted threshold for significance (that is, accounting for the fact you did four comparisons–city vs. non-city in four regions). Your interpretation should report direction of the associations (that is which group has higher vocabulary scores), the effect size, and the p value (make clear if you are using the Bonferroni-adjusted p value or the unadjusted p value).

```{r}
sc_city$bonf_p <- p.adjust(sc_city$p.value, method = "bonferroni")
sc_city
```

APA-style write-up (Bonferroni-adjusted): In the Midwest, city dwellers scored higher than non-city dwellers, t(312) = 2.96, p_bonf = .013, d = 0.66. In the Northeast, non-city dwellers scored higher than city dwellers, t(312) = 7.23, p_bonf < .001, d = 1.62. The South and West comparisons were not significant (both p_bonf = 1.00).

# Problem 14 (1 pt)

Write a null hypothesis for the simple effect of Midwest versus Northeast, among city dwellers.

Null: among city dwellers, the Midwest and Northeast population means are equal.

# Problem 15 (1 pt)

Have R produce pairwise contrasts for region among city-dwellers and among non-city dwellers (that is, the simple effects of region by city status). Again, specify `"none"` for `adjust`.

```{r}
pairs(em_cell, simple = "regions_f", adjust = "none")
```

# Problem 16 (2 pts)

We need to account for the fact that we can do the region comparisons for two urbanicity statuses. Use R to calculate the Tukey HSD adjusted critical value for the simple main effects of region by city status, keeping the familywise error rate at 0.05 (a \"Tukey HSD + Bonferroni\" adjustment).

```{r}
crit_t_region_simple <- qtukey(1 - alpha/2, A, df_error) / sqrt(2)
crit_t_region_simple
```

# Problem 17 (12 pts)

Identify the contrasts that survive the Tukey HSD+Bonferroni adjustment.

```{r}
sc_region <- as.data.frame(pairs(em_cell, simple = "regions_f", adjust = "none"))
sc_region$survive <- abs(sc_region$t.ratio) >= crit_t_region_simple
sc_region[sc_region$survive == TRUE, c("contrast", "sized_f", "t.ratio", "p.value")]
```

# Problem 18 (3 pt)

Write three null hypotheses:
* the simple effect of Northeast vs Midwest and West, among city-dwellers
* the simple effect of Northeast vs Midwest and West, among non-city dwellers.
* the interaction contrast comparing the above two simple effects

- City dwellers, NE vs MW & W: Null: among city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
- Non-city dwellers, NE vs MW & W: Null: among non‑city dwellers, the Northeast mean equals the average of Midwest and West (no Northeast advantage).
- Interaction contrast: Null: the Northeast vs (Midwest & West) contrast is the same for city and non‑city dwellers (no interaction contrast).

# Problem 19 (3 pt)

Create contrast vectors for a complex contrast of Northeast vs Midwest and West among city dwellers and non-city dwellers. Your vectors should have eight values in them, listing the contrast coefficients for the cells, in the order they are listed in the cell `emmGrid` object.

```{r}
contrast_city <- c(0, -0.5, 0, 1, 0, 0, 0, -0.5)
contrast_noncity <- c(-0.5, 0, 1, 0, 0, 0, -0.5, 0)
contrast_interaction <- contrast_city - contrast_noncity

contrast_city
contrast_noncity
contrast_interaction
```

# Problem 20 (1 pt)

Assemble the contrast vectors in a list.

```{r}
contrast_list <- list(
  city_NE_vs_MW_W = contrast_city,
  noncity_NE_vs_MW_W = contrast_noncity,
  interaction_NE_vs_MW_W = contrast_interaction
)
contrast_list
```

# Problem 21 (1 pt)

Have R calculate these contrasts using the cell `emmGRID` object. Do not apply any adjustments--yet.

```{r}
complex_contrasts <- contrast(em_cell, contrast_list, adjust = "none")
complex_contrasts
```

# Problem 22 (2 pt)

Calculate the Scheffe- and Bonferroni-adjusted critical value for a a complex simple contrast of region by city status. Take the square root to get a critical value comparable to a t-statistic.

```{r}
scheffe_simple_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_error))
bonf_simple_t <- qtukey(1 - alpha/2, 2, df_error) / sqrt(2)

scheffe_simple_t
bonf_simple_t
```

# Problem 23 (2 pt)

Calculate the Scheffe-adjusted critical value for an interaction contrast. Take the square root to get a critical value comparable to a t-statistic.

```{r}
scheffe_interaction_t <- sqrt((A - 1) * (2 - 1) * qf(1 - alpha, (A - 1) * (2 - 1), df_error))
scheffe_interaction_t
```

# Problem 24 (3 pt)

Calculate Cohen's *d* for the three contrasts.

```{r}
cc <- as.data.frame(complex_contrasts)
cc$d <- cc$estimate / sd_pooled
cc
```

# Problem 25 (5 pts)

Write-up the Northeast vs Midwest & West contrasts (and interaction contrast) as you would for a publication.

APA-style write-up: For city dwellers, the Northeast vs (Midwest & West) contrast was significant, t(312) = 5.61, p < .001, d = 1.09, indicating lower Northeast scores than the average of Midwest and West for city residents (estimate = -1.03). For non-city dwellers, the same contrast was significant, t(312) = 3.83, p = .0002, d = 0.74, indicating higher Northeast scores than the average of Midwest and West (estimate = 0.70). The interaction contrast was significant, t(312) = 6.67, p < .001, d = 1.83, showing that the Northeast advantage differs sharply by city status.

# Problem 26 (0 points)

Upload your this document to Canvas. Double-check your submission to make sure it took.
