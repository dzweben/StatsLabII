---
title: "Lab 8"
author: "Joshua Klugman"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
root_dir <- normalizePath("..")
knitr::opts_knit$set(root.dir = root_dir)

.libPaths(c(file.path(root_dir, "rlib"), .libPaths()))

library(tidyverse)
library(haven)
library(emmeans)
library(afex)
library(pastecs)
library(car)
source(file.path(root_dir, "Rallfun-v45.txt"))
```

# Lab 8 overview

The data in the file `wordsum v2.sav` is a vocabulary test administered to people from different regions of the United States, with scores ranging from 0 to 10. We have a 2×4 design, with our two factors being a city resident (versus not being a city resident; this is variable `sized`) and region (Midwest, Northeast, South, and West; this is variable `regions`). The outcome is the vocabulary score (variable `ws` which is a count variable ranging from 0 correct words to 10 correct words).

# Problem 1

Load packages and Wilcox functions.

```{r}
# packages
library(afex)
library(car)
library(emmeans)
library(haven)
source("https://osf.io/download/98b7r/")
```

# Problem 2

Read in the `wordsum v2.sav` datafile.

```{r}
ws <- read_sav("wordsum v2.sav")
```

# Problem 3

Inspect labels, create factor versions, and verify construction.

```{r}
attr(ws$sized, "labels")
attr(ws$regions, "labels")

ws$sized_f <- factor(ws$sized,
                     levels = c(0, 1),
                     labels = c("Non-City", "City"))

ws$regions_f <- factor(ws$regions,
                       levels = c(1, 2, 3, 4),
                       labels = c("Midwest", "Northeast", "South", "West"))

# confirm factor construction

table(ws$sized, ws$sized_f, exclude = NULL)

table(ws$regions, ws$regions_f, exclude = NULL)
```

# Problem 4

Create a superfactor and cross-tabulate with city status and region.

```{r}
ws <- group_by(ws, sized_f, regions_f)
ws <- mutate(ws, regionsize_new = cur_group_id())
ws <- ungroup(ws)

# add labels for the superfactor
ws$regionsize_new_f <- factor(ws$regionsize_new,
                              levels = 1:8,
                              labels = c("Midwest Non-City", "Northeast Non-City",
                                         "South Non-City", "West Non-City",
                                         "Midwest City", "Northeast City",
                                         "South City", "West City"))

# cross-tabs

table(ws$regionsize_new_f, ws$sized_f, exclude = NULL)

table(ws$regionsize_new_f, ws$regions_f, exclude = NULL)
```

# Problem 5

Histograms by city status and region.

```{r, fig.cap="Vocabulary scores by region and city status"}
ggplot(data = ws, aes(x = ws)) +
  geom_histogram() +
  facet_grid(regions_f ~ sized_f)
```

# Problem 6

Skewness statistics and Shapiro-Wilk tests for each cell.

```{r}
tapply(ws$ws, ws$regionsize_new_f, pastecs::stat.desc, norm = TRUE)
```

# Problem 7

Levene's test for homogeneity of variance.

```{r}
car::leveneTest(ws ~ regionsize_new_f, data = ws, center = mean)
```

# Problem 8

Use MAD-Median rule to detect outliers.

```{r}
o <- tapply(ws$ws, ws$regionsize_new_f, outpro)
o

# If outliers appear in any group, run this for each group with outliers:
# ws$ws[ws$regionsize_new_f=="GROUP NAME"][o[["GROUP NAME"]]$out.id]
```

# Problem 9

Diagnostics write-up (3 sentences maximum).

Based on the histograms and skewness statistics, the distributions appear only modestly skewed across cells. Shapiro-Wilk tests indicate statistically significant departures from normality in each cell (all p-values < .01). Levene’s test suggests homogeneity of variances across the eight cells (p = .8907), and the MAD-Median rule indicates no outliers in any cell.

# Problem 10

Create an ID variable.

```{r}
ws$id <- rownames(ws)
```

# Problem 11

Cell and marginal means.

```{r}
ws_anova <- aov_car(ws ~ sized_f * regions_f + Error(id), data = ws)

# cell means
emmeans(ws_anova, ~ sized_f * regions_f)

# marginal means
emmeans(ws_anova, ~ sized_f)
emmeans(ws_anova, ~ regions_f)
```

# Problem 12

Excel table of cell means.

```{r}\n# cell means table (paste into Excel and format)\ncell_means <- as.data.frame(emmeans(ws_anova, ~ regions_f * sized_f))\ncell_table <- cell_means |>\n  select(regions_f, sized_f, emmean) |>\n  pivot_wider(names_from = sized_f, values_from = emmean)\ncell_table\n```

Create a 4x2 table in Excel with rows as `regions_f` and columns as `sized_f`. Use the cell means above, round to two decimals, and format with a clear title and minimal borders.

# Problem 13

Interpretability of main effects.

The interaction between city status and region is significant, so the main effects are not safe to interpret. The city vs. non-city differences are not consistent across regions, and the rank order of regions changes across city status.

# Problem 14

Two-way ANOVA output.

```{r}
summary(ws_anova)
ws_anova$Anova
```

# Problem 15

Calculate partial omega squared for each effect.

```{r}
an <- as.data.frame(ws_anova$Anova)
ss <- an$`Sum Sq`
df <- an$Df
names(ss) <- row.names(an)
names(df) <- row.names(an)

ss_error <- ss["Residuals"]
df_error <- df["Residuals"]
mse <- ss_error / df_error

effects <- setdiff(row.names(an), c("(Intercept)", "Residuals"))
ss_effect <- ss[effects]
df_effect <- df[effects]

omega_p <- (ss_effect - df_effect * mse) / (ss_effect + ss_error + mse)

omega_table <- data.frame(
  effect = effects,
  df = df_effect,
  SS = ss_effect,
  SS_error = ss_error,
  MSE = mse,
  omega_p = omega_p
)
omega_table
```

# Problem 16

Write up the omnibus results (journal style).

A two-way ANOVA showed a significant main effect of city status, F(1, 312) = 6.19, p = .013, ω²p = 0.016, and a significant main effect of region, F(3, 312) = 3.03, p = .030, ω²p = 0.019. There was also a significant city status × region interaction, F(3, 312) = 18.68, p < .001, ω²p = 0.144. Because the interaction is significant, interpretation should focus on the cell means rather than the marginal main effects.

# Problem 17

Upload the document to Canvas and verify the submission.
