---
title: "Lab 12"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

# IMPORTANT: Set your working directory to the Lab12 folder before running.
# Example:
# setwd("/Users/dannyzweben/Desktop/GradClass/Y1/S2/StatsII/StatsII-Labs/Lab12")

library(afex)
library(emmeans)
library(haven)
library(tidyverse)

load("relax.rda")
```

Researchers were interested in finding out if relaxation techniques can mitigate the stress college students feel over the course of a semester.  They tracked two groups of dental students over an academic year, taking measurements in September (low stress), November (high stress), April (high stress), June (high stress), and July (low stress).  One group was given relaxation therapy  (TREATMENT = 2) and the control group (TREATMENT = 1) was given no therapy at all.  
The dependent variable is the rate of secretion of salivary secretory immunoglobulin A (s-IgA) that was measured in each month (unit of measurement: mg s-IgA/min).  Higher values mean stronger functioning of the immune system (and hence less stress).  The data is available on Canvas.

## Problem 1 (0 pts)

Load these packages into memory: `afex`, `emmeans`, `haven`, `tidyverse`, 

```{r}
library(afex)
library(emmeans)
library(haven)
library(tidyverse)
```

## Problem 2 (0 pts)

Set your working directory and load the `relax.rda` data file into memory, which contains the `r` dataframe.

```{r}
# setwd("/Users/dannyzweben/Desktop/GradClass/Y1/S2/StatsII/StatsII-Labs/Lab12")
load("relax.rda")
```

## Problem 3 (1 pt)

Reshape the data frame to a "long" or person-period dataframe.

```{r}
long <- pivot_longer(r, cols = c(sept, nov, april, june, july),
                     names_to = "month",
                     values_to = "siga")
long <- as.data.frame(long)
head(long)
```

## Problem 4 (1 pt) 

Do the omnibus split-plot ANOVA test.

```{r}
long$month <- factor(long$month, levels = c("sept", "nov", "april", "june", "july"))
long$treatmentf <- factor(long$treatmentf)

model <- aov_car(siga ~ month * treatmentf + Error(ID/month), data = long)
summary(model)
```

## Problem 5 (1 pt)

Get an `emmeans` object for the month marginal means.  Print the `emmeans` object.

```{r}
em_month <- emmeans(model, ~ month)
em_month
```

## Problem 6 (1 pt)

Get an `emmeans` object for the condition marginal means.  Print the `emmeans` object.  The `EMOBJECT` should have a different name than the one you used before.

```{r}
em_treat <- emmeans(model, ~ treatmentf)
em_treat
```

## Problem 7 (1 pt)

Get an `emmeans` object for the cell means.  Print the `emmeans` object.

```{r}
em_cell <- emmeans(model, ~ month * treatmentf)
em_cell
```

## problem 8 (1 pt)

Save the cell `emmeans` object as a dataframe.

```{r}
cell_df <- as.data.frame(em_cell)
cell_df
```

## Problem 9 (1 pt)

In Excel make a spreadsheet showing these cell and marginal means, with the rows corresponding to treatment and the columns corresponding to month.  Copy the spreadsheet here.  You round to thousandths.  Do not worry about polish.  This is just to help you understand what is going on with the data.

```{r}
cell_wide <- cell_df %>%
  select(treatmentf, month, emmean) %>%
  pivot_wider(names_from = month, values_from = emmean)
month_means <- as.data.frame(em_month)
month_means <- month_means[match(c("sept", "nov", "april", "june", "july"), month_means$month), ]
cell_wide$Mean <- as.data.frame(em_treat)$emmean

mean_row <- data.frame(
  treatmentf = "Month Mean",
  sept = month_means$emmean[1],
  nov = month_means$emmean[2],
  april = month_means$emmean[3],
  june = month_means$emmean[4],
  july = month_means$emmean[5],
  Mean = mean(month_means$emmean)
)

table_df <- bind_rows(cell_wide, mean_row)

num_cols <- setdiff(names(table_df), "treatmentf")
table_df[num_cols] <- lapply(table_df[num_cols], function(x) round(as.numeric(x), 3))

knitr::kable(table_df)
```

## Problem 10 (1 pt)

We have a problem: we want to graph this data (using the cell `emmeans`-object-turned-dataframe), but R is going to arrange the months alphabetically using unpolished month labels (april - july - june - nov - sept) rather than chronologically using polished labels (September - November - April - June - July).  In the cell-level dataframe, create a new month variable that is a factor version of the original month variable.   You will need to use the `levels` argument to specify the chronological order of the months, and the `labels` argument to give formal names to the months (e.g. "September" instead of "sept").

```{r}
cell_df$month_f <- factor(cell_df$month,
                          levels = c("sept", "nov", "april", "june", "july"),
                          labels = c("September", "November", "April", "June", "July"))
cell_df$month_f
```

## Problem 11 (1 pt)

Produce a polished line graph showing the cell means.  Note that in practice you should also present Cousineau-Morey confidence intervals, but I will spare you that for this lab assignment.

```{r, fig.cap="Cell means by month and treatment"}
plot_obj <- ggplot(data = cell_df, aes(x = month_f, y = emmean, color = treatmentf, group = treatmentf)) +
  geom_line() +
  geom_point() +
  labs(title = "s-IgA Over Time by Treatment",
       x = "Month",
       y = "s-IgA (mg/min)",
       color = "Treatment") +
  theme_minimal()
plot_obj
```

## Problem 12 (1 pt)

Re-do the omnibus test, but this time pretend this is a between-subject design, with each observation corresponding to a different individual.  First you will create a fake ID variable for each observation.  Identify the residual MS, take its square root and get the pooled SD (round to ten thousandths, four decimal places).

```{r}
long$fakeid <- seq(1, nrow(long))
model2 <- aov_car(siga ~ month * treatmentf + Error(fakeid), data = long)
summary(model2)

anova_tab2 <- as.data.frame(model2$anova_table)
pooled_sd <- sqrt(anova_tab2$MSE[1])
round(pooled_sd, 4)
```

## Contrasts

For each contrast: (a) write the null hypothesis (1 pt); (b) ask R to perform the contrast, if applicable(1 pt); (c) show the calculations for the adjusted critical value for a post-hoc contrast (2 pts); (d) state if you reject or retain the null (1 pt); (e) Report  d~av~ (if applicable, 1 pt).

## Problem 13 (6 pts)

The difference between the low-stress months (September, July) and high-stress months (November, April, June) for everyone.

H0: (0.5)μ_Sept + (-1/3)μ_Nov + (-1/3)μ_April + (-1/3)μ_June + (0.5)μ_July = 0

```{r}
low_high <- c(0.5, -1/3, -1/3, -1/3, 0.5)
contrast(em_month, list(low_vs_high = low_high))

A <- 5
alpha <- 0.05
df_err <- 20
scheffe_t <- sqrt((A - 1) * qf(1 - alpha, A - 1, df_err))
scheffe_t

d_av_13 <- 0.03098485 / pooled_sd
d_av_13
```

Decision: |t| = 9.34 > 3.39, reject H0.  d~av~ = 0.72.

## Problem 14 (6 pts)

The difference between the low-stress months and high-stress months for subjects in the relaxation treatment.

H0: (0.5)μ_RT,Sept + (-1/3)μ_RT,Nov + (-1/3)μ_RT,April + (-1/3)μ_RT,June + (0.5)μ_RT,July = 0

```{r}
contrast(em_cell, list(low_vs_high = low_high), by = "treatmentf")

scheffe_t

d_av_14 <- 0.02136364 / pooled_sd
d_av_14
```

Decision (Relaxation Therapy): |t| = 4.55 > 3.39, reject H0.  d~av~ = 0.50.

## Problem 15 (6 pts)

The difference between the low-stress months and high-stress months for subjects in the control treatment.

H0: (0.5)μ_C,Sept + (-1/3)μ_C,Nov + (-1/3)μ_C,April + (-1/3)μ_C,June + (0.5)μ_C,July = 0

```{r}
contrast(em_cell, list(low_vs_high = low_high), by = "treatmentf")

scheffe_t

d_av_15 <- 0.04060606 / pooled_sd
d_av_15
```

Decision (Control): |t| = 8.65 > 3.39, reject H0.  d~av~ = 0.94.

## problem 16 (6 pts)

The relaxation-control difference in the low stress month/high stress month differential.

H0: (-0.5)μ_C,Sept + (1/3)μ_C,Nov + (1/3)μ_C,April + (1/3)μ_C,June + (-0.5)μ_C,July + (0.5)μ_RT,Sept + (-1/3)μ_RT,Nov + (-1/3)μ_RT,April + (-1/3)μ_RT,June + (0.5)μ_RT,July = 0

```{r}
em_full <- emmeans(model, ~ month * treatmentf)

w_control <- c(-0.5, 1/3, 1/3, 1/3, -0.5)
w_treat <- c(0.5, -1/3, -1/3, -1/3, 0.5)
w_diff <- c(w_control, w_treat)

contrast(em_full, list(diff_of_diff = w_diff))

scheffe_t

d_av_16 <- -0.0192 / pooled_sd
d_av_16
```

Decision: |t| = 2.90 < 3.39, retain H0.  d~av~ = -0.45.
